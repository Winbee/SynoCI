# Goal

This repo is made to provide a guide to install a basic infrastructure for Continuous integration on a NAS Synology.

# What does it contains

Here is a schema of the architecture:
![architecture_schema](https://rawgit.com/Winbee/SynoCI/master/extra/architecture_schema.svg)

Everything run on the NAS itself. The Firewall, DNS Server and Reverse Proxy are available in DSM 6. The other elements come from the official docker hub.

A brief introduction:
- [Gogs](https://github.com/gogits/gogs): a self-hosted Git service.
- [Nexus](https://books.sonatype.com/nexus-book/reference3/): an artifact repository for java, javascript, docker, C#, Python or Ruby packages
- [Jenkins](https://jenkins.io/): an automation server used to automate the CI jobs.
- [Portainer](http://portainer.io/): an UI to manage the docker environnment

# Limitation

This has only been tested on a Synology DS716+ upgraded with 8Gb of ram (If you are interested to upgrade yours as well, it's this one 	Kingston 8GB DDR3L 1600MHz KVR16LS11/8). In theory, it should work with any other x86 NAS Synology with at least 4Gb of ram.

# How to proceed
## Warm up
- First go check this [page](https://www.synology.com/en-global/knowledgebase/DSM/tutorial/General/How_to_add_extra_security_to_your_Synology_NAS) to add extra security on your NAS.
- Activate the ssh service of the NAS by following this [page](https://www.synology.com/en-global/knowledgebase/DSM/help/DSM/AdminCenter/system_terminal).


## Docker
Install Docker Package in the DSM. This should create two new directory on your NAS:
  - ```/volume1/docker```
  - ```/volume1/@docker```
  
From what I understood, ```/volume1/@docker``` contain all the data generated by docker i.e. the images, the containers, the volumes and other things. The other directory ```/volume1/docker``` contains a directory called "docker_registry" but we won't use it. The interesting part is that ```/volume1/docker``` is a shared folder and therefore can be easily encrypted directly in DSM UI.

All the docker containers that we will run will have a [data volume](https://docs.docker.com/engine/tutorials/dockervolumes/#data-volumes) attached to them. This data volume will won't be lost if the container is stopped or removed. By default, the docker volume are created 
here ```/volume1/@docker/volumes```. We have to change that and put the volumes directory in the ```/volume1/docker``` folder. Connect 
yourself to your NAS with SSH and the following command:
``` bash
# Swith to root user
sudo su
# Move the old folder to the new place
mv /volume1/@docker/volumes /volume1/docker/volumes
# Create a symbolic link to keep the same structure as before.
ln -s /volume1/docker/volumes /volume1/@docker/volumes
```

### Docker with SSL
Docker communicates with HTTPS and SSL. The url to access the docker registry in Nexus need to have a certificate.

If this certificate is signed by a known autority, everything should be fine. However if it's self-signed certificate, Docker will shoot at you that the certificate come from an unknown autority and won't be able to do anything.

As stated on [stackoverflow](http://stackoverflow.com/questions/26710153/remote-access-to-a-private-docker-registry), you have to add your registry as an insecure registry in the docker service.

``` bash
vim /etc/docker/daemon.json 
{
	"hosts": ["fd://"],
	"insecure-registries": ["docker-all.mydomain.com", "docker-hosted.mydomain.com"]
}
```

``` bash
sudo vim /lib/systemd/system/docker.service
#ExecStart=/usr/bin/dockerd
ExecStart=/usr/bin/dockerd -H fd://
```

``` bash
sudo systemctl stop docker
sudo systemctl daemon-reload
systemctl start docker
```

In synology; you have to change this:
``` bash
vim /var/packages/Docker/etc/dockerd.json 
{
	"ipv6": true,
	"insecure-registries": ["docker-all.mydomain.com", "docker-hosted.mydomain.com"]
}
```

# Todo

DNS

Nginx redirection

Maven config

Npm/yarn config

Docker config

Certificate

Test with the proof project

double git

Security
- encrypt volume folder
- firewall
- MFA
- ssh

backup

